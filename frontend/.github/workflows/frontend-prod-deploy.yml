name: Frontend CD (Prod)

on:
  push:
    branches: ["prod"]

jobs:
  run-ci:
    uses: ./.github/workflows/frontend-ci.yml

  deploy-frontend:
    name: Deploy frontend (prod)
    needs: run-ci
    environment: prod
    runs-on: ubuntu-latest

    defaults:
      run:
        working-directory: frontend

    env:
      S3_BUCKET: ${{ secrets.S3_FRONTEND_BUCKET }}
      CLOUDFRONT_DISTRIBUTION_ID: ${{ secrets.CF_DISTRIBUTION_ID }}
      AWS_REGION: eu-north-1

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        run: npm install --ignore-scripts

      - name: Build
        run: npm run build:prod
        env:
          VITE_API_BASE_URL: ${{ secrets.VITE_API_BASE_URL }}
          VITE_LINKEDIN_REDIRECT_URI: ${{ secrets.VITE_LINKEDIN_REDIRECT_URI }}
          VITE_LINKEDIN_CLIENT_ID: ${{ secrets.VITE_LINKEDIN_CLIENT_ID }}
          VITE_LINKEDIN_SCOPE: ${{ secrets.VITE_LINKEDIN_SCOPE }}

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Sync to S3
        run: |
          aws s3 sync dist/ s3://$S3_BUCKET/ --delete

      - name: Invalidate CloudFront
        run: |
          aws cloudfront create-invalidation \
            --distribution-id $CLOUDFRONT_DISTRIBUTION_ID \
            --paths "/*"

  notify-on-failure:
    name: Notify on failure
    runs-on: ubuntu-latest
    needs: [run-ci, deploy-frontend]
    if: failure()

    steps:
      - name: Send Slack notification
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          WORKFLOW: ${{ github.workflow }}
          RUN_URL: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}
        run: |
          payload=$(cat <<EOF
          {
            "text": ":x: *${WORKFLOW} failed*\n\
            *Reason:* One or more steps in this job failed\n\
            <${RUN_URL}|View full logs>"
          }
          EOF
          )

          curl -X POST -H "Content-type: application/json" \
            --data "$payload" \
            "$SLACK_WEBHOOK_URL"
