name: Frontend CI

on:
  pull_request:
    branches: [ "main", "prod" ]

  workflow_call:

jobs:
  ci:
    name: CI
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: frontend
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies (no native scripts)
        run: npm install --ignore-scripts
        
      - name: Check for Hebrew characters
        run: |
          set -euo pipefail

          echo "üîç Scanning repository for Hebrew characters..."

          MATCHES=$(git ls-files \
            | xargs grep -nP '[\x{0590}-\x{05FF}]' || true)

          if [ -n "$MATCHES" ]; then
            echo "‚ùå Hebrew characters detected:"
            echo "$MATCHES"
            exit 1
          else
            echo "‚úÖ No Hebrew characters found."
          fi

      - name: Lint
        run: npm run lint

      - name: Format check
        run: npx prettier --check .

      - name: Build
        env:
          ENVIRONMENT: ${{ github.ref_name == 'prod' && 'prod' || 'dev' }}
        run: npm run build:${{ env.ENVIRONMENT }}
  
  notify-on-failure:
    name: Notify on failure
    runs-on: ubuntu-latest
    needs: [ ci ]

    if: failure()

    steps:
      - name: Send Slack notification
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          WORKFLOW: ${{ github.workflow }}
          RUN_URL: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}
        run: |
          payload=$(cat <<EOF
          {
            "text": ":x: *${WORKFLOW} failed*\n\
            *Reason:* One or more steps in this job failed\n\
            <${RUN_URL}|View full logs>"
          }
          EOF
          )

          curl -X POST -H "Content-type: application/json" \
            --data "$payload" \
            "$SLACK_WEBHOOK_URL"