name: Backend CD (Prod)
on:
  push:
    branches: [ "main" ]

jobs:
  run-ci:
    name: Run Backend CI
    uses: ./.github/workflows/backend-ci.yml
    secrets:
      RAG_SCRAPING_GITHUB_TOKEN: ${{ secrets.RAG_SCRAPING_GITHUB_TOKEN }}

  deploy-backend:
    name: Deploy backend to EC2 (prod)
    needs: run-ci
    environment: prod
    runs-on: ubuntu-latest

    env:
      AWS_REGION: eu-north-1
      EC2_INSTANCE_ID: ${{ secrets.EC2_INSTANCE_ID }}

    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id:     ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Trigger deploy script on EC2 via SSM
        id: ssm
        run: |
          COMMAND_ID=$(aws ssm send-command \
            --instance-ids "$EC2_INSTANCE_ID" \
            --document-name "AWS-RunShellScript" \
            --comment "Deploy backend (dev) from GitHub Actions" \
            --parameters '{
              "executionTimeout":["3600"],
              "workingDirectory":["/home/ubuntu"],
              "commands":[
                "sudo -u ubuntu bash /opt/backend/deploy_backend.sh prod"
              ]
            }' \
            --query "Command.CommandId" \
            --output text)

          echo "command_id=$COMMAND_ID" >> $GITHUB_OUTPUT
          echo "SSM Command ID: $COMMAND_ID"

      - name: Wait for deployment to finish
        run: |
          aws ssm wait command-executed \
            --instance-id "$EC2_INSTANCE_ID" \
            --command-id "${{ steps.ssm.outputs.command_id }}"

  notify-on-failure:
    name: Notify on failure
    runs-on: ubuntu-latest
    needs: [run-ci, deploy-backend]

    if: failure()

    steps:
      - name: Send Slack notification
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          WORKFLOW: ${{ github.workflow }}
          RUN_URL: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}
        run: |
          payload=$(cat <<EOF
          {
            "text": ":x: *${WORKFLOW} failed*\n\
            *Reason:* One or more steps in this job failed\n\
            <${RUN_URL}|View full logs>"
          }
          EOF
          )

          curl -X POST -H "Content-type: application/json" \
            --data "$payload" \
            "$SLACK_WEBHOOK_URL"