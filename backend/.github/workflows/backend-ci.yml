name: Backend CI

on:
  pull_request:
    branches: ["main", "prod"]

  workflow_call:
    secrets:
      RAG_SCRAPING_GITHUB_TOKEN:
        required: true

jobs:
  
  setup:
    name: Setup Python Environment
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: backend
    outputs:
      python-version: ${{ steps.setvers.outputs.python_version }}
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure git auth for private repos
        run: |
          git config --global url."https://x-access-token:${{ secrets.RAG_SCRAPING_GITHUB_TOKEN }}@github.com/".insteadOf "https://github.com/"

      - name: Select Python version
        id: setvers
        run: echo "python_version=3.11" >> $GITHUB_OUTPUT

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Poetry
        run: |
          curl -sSL https://install.python-poetry.org | python3 -
          echo "$HOME/.local/bin" >> $GITHUB_PATH
      
      - name: Install dependencies
        run: |
          poetry install --no-interaction --no-root

      - name: Check missing or unused dependencies
        run: |
           poetry run deptry . || (echo "❌ Missing or unused dependencies detected" && exit 1)

      - name: Python syntax validation
        run: |
          poetry run python -m py_compile $(git ls-files '*.py')

      - name: Check module imports
        run: |
          poetry run python - << 'EOF'
          import pkgutil
          import app
          print("All modules imported successfully.")
          EOF

  env-params:
    name: Environment Parameters Validation
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: backend
    needs: setup

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure git auth for private repos
        run: |
          git config --global url."https://x-access-token:${{ secrets.RAG_SCRAPING_GITHUB_TOKEN }}@github.com/".insteadOf "https://github.com/"

      - name: Select Python version
        id: setvers
        run: echo "python_version=3.11" >> $GITHUB_OUTPUT

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Poetry
        run: |
          curl -sSL https://install.python-poetry.org | python3 -
          echo "$HOME/.local/bin" >> $GITHUB_PATH
      
      - name: Install dependencies
        run: |
          poetry install --no-interaction --no-root

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id:     ${{ secrets.CI_AWS_ACCESS_KEY }}
          aws-secret-access-key: ${{ secrets.CI_AWS_SECRET_ACCESS_KEY }}
          aws-region: eu-north-1

      # 1. No direct env access outside config.py
      - name: Check for direct environment variable access
        run: |
          poetry run python scripts/ci/check_no_direct_env_access.py

      # 2. .env.example matches config.py
      - name: Check .env.example matches config.py
        run: |
          poetry run python scripts/ci/check_env_example_vs_config.py

      # 3. settings.NAME usage validation
      - name: Check settings usage declared in config.py
        run: |
          poetry run python scripts/ci/check_settings_usage_declared.py

      # 4. config.py <-> SSM declaration match
      - name: Env contract - config vs SSM lists
        run: |
          poetry run python scripts/ci/check_config_vs_ssm_declaration.py

      # 5. SSM existence check
      - name: Check required SSM parameters exist
        id: ssm_check
        continue-on-error: true
        run: |
          bash scripts/ci/check_ssm_params_existence.sh
      
      # 6. Slack notification if missing SSM params
      - name: Notify DevOps on missing SSM params
        if: steps.ssm_check.outcome == 'failure'
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SSM_MISSING_SLACK_WEBHOOK_URL }}
          GITHUB_ACTOR: ${{ github.actor }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          GITHUB_SERVER_URL: ${{ github.server_url }}
          GITHUB_RUN_ID: ${{ github.run_id }}
        run: |
         bash scripts/ci/slack_notify_missing_ssm.sh
      
      # 7. Fail job after notification
      - name: Fail job if SSM params are missing
        if: steps.ssm_check.outcome == 'failure'
        run: exit 1
      
  lint:
    name: Lint (Black + isort + ruff)
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: backend
    needs: [ setup, env-params ]

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure git auth for private repos
        run: |
          git config --global url."https://x-access-token:${{ secrets.RAG_SCRAPING_GITHUB_TOKEN }}@github.com/".insteadOf "https://github.com/"

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: 3.11
      
      - name: Check for forbidden Hebrew characters
        run: |
          set -e
          MESSAGES=$(
            git ls-files \
            | xargs awk '
              BEGIN { allow_next = 0 }
              {
                if ($0 ~ /# i18n: allowed-hebrew/) {
                  allow_next = 1
                  next
                }
                if (allow_next == 1) {
                  allow_next = 0
                  next
                }
                print
              }
            ' \
            | grep -nP '[\x0590-\x05FF]' || true
          )
          
          if [ -n "$MESSAGES" ]; then
            echo "❌ Hebrew characters detected in source files:"
            echo "$MESSAGES"
            exit 1
          else
            echo "✓ No Hebrew characters found."
          fi
      
      - name: Install Poetry
        run: |
          curl -sSL https://install.python-poetry.org | python3 -
          echo "$HOME/.local/bin" >> $GITHUB_PATH
      
      - name: Install tooling
        run: poetry install --no-interaction --no-root

      - name: Black check
        run: poetry run black --check .

      - name: isort check
        run: poetry run isort . --check-only --diff

      - name: ruff check
        run: poetry run ruff check .
      
  docker-build-test:
    name: Docker build & runtime validation
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: backend
    needs: lint

    steps:
      - uses: actions/checkout@v4

      - name: Build docker image
        run: docker build --build-arg GITHUB_TOKEN=${{ secrets.RAG_SCRAPING_GITHUB_TOKEN }} -t backend-ci-test .

      - name: Run container (startup test)
        run: |
          docker run --rm \
            -e ENVIRONMENT=test \
            -e MONGODB_URL="mongodb://localhost:27017" \
            -e MONGODB_NAME="test" \
            -e DATABASE_NAME="test" \
            backend-ci-test \
            sh -c "python -c 'import app; print(\"App import OK\")'"

    # NOTE:
    # mypy is intentionally not run in CI. (poetry run mypy .)
    # We rely on:
    # - config/SSM contract checks
    # - ruff
    # - runtime docker validation
    # Static typing may be reintroduced later per-module.

  notify-on-failure:
    name: Notify on failure
    runs-on: ubuntu-latest
    needs: [setup, env-params, lint, docker-build-test]

    if: failure()

    steps:
      - name: Send Slack notification
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          WORKFLOW: ${{ github.workflow }}
          RUN_URL: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}
        run: |
          payload=$(cat <<EOF
          {
            "text": ":x: *${WORKFLOW} failed*\n\
            *Reason:* One or more steps in this job failed\n\
            <${RUN_URL}|View full logs>"
          }
          EOF
          )

          curl -X POST -H "Content-type: application/json" \
            --data "$payload" \
            "$SLACK_WEBHOOK_URL"